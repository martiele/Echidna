
tinymce.PluginManager.add("image", function(e) {


    var mediabrowser = new MediaBrowser("#filebrowser");

    mediabrowser.fileChoose(function (file) {
        e.selection.setContent('<img src="'+file.permalink+'">');
    });

    var container,b;
    e.addButton("image", {
        icon: "image",
        tooltip: "Insert/edit image",
        onclick: prova,
        stateSelector: "img:not([data-mce-object],[data-mce-placeholder])"
    }), e.addMenuItem("image", {
        icon: "image",
        text: "Insert image",
        onclick: prova,
        context: "insert",
        prependToContext: !0
    }), e.addCommand("mceImage", n())

    function n() {

    }
    
    function prova() {
        mediabrowser.open();
    }

    function create_popup(){


        (function(ty){
            popup(window.echidna_url+"media/insert_image?b=ajax",ty,function(ret){


                (function(e){


                    $.ajax({
                        url: window.echidna_url+"media/ajax_get_single/"+ret.value+"?b=ajax",

                        data:sendData,


                        method:"POST",
                        success: function (d) {

                            item=JSON.parse(d);
                            ret=item.permalink;

                            console.log(e);
                            e.selection.setContent('<img src="'+window.media_url+ret+'">');

                        }
                    });
                })(e);

            });
        })(e);

    }
    function build_header(){
        /*ro=document.createElement("div");
        ro.className="popup-top-menu";
        ro.innerHTML='<ul><li>' +
        '<a href="" >Scegli da immagini gi√É </a></li>' +
        '<li><a href="http://localhost:8888/kaos/admin/media/new" >Carica nuova immagine</a></li></ul>';
        */

        a=document.createElement("a");
        a.className="close-popup btn cancel f_r";
        a.href="javascript:void(0)";
        a.onclick=function(e){
            e.preventDefault();
            $(window).trigger("popup_close");
        };

        a.innerHTML="Chiudi";

        //$(ro).append(a);
        //$(ro).append("<hr>");
        //return ro;
        return a;
    }
    function open_popup(){

        (function(ty){
            popup(window.echidna_url+"media/ajax-list?b=ajax",ty,function(ret){

                console.log(ret);
                (function(e){


                    $.ajax({
                        url: window.echidna_url+"media/ajax_get_single/"+ret.value+"?b=ajax",

                        data:sendData,


                        method:"POST",
                        success: function (d) {

                            item=JSON.parse(d);
                            ret=item.permalink;

                            console.log(e);
                            e.selection.setContent('<img src="'+window.media_url+ret+'">');

                        }
                    });
                })(e);

            });
        })(e);

        return false;
        obscurate=document.createElement("div");

        container=document.createElement("div");
        alert("creo");
        with(obscurate.style){
            position="fixed";
            top="00%";
            left="0%";
            width="100%";
            height="100%";
            background="#333333";
            zIndex="1000000";
            opacity="0.5";
        }
        b=document.getElementsByTagName("body")[0];

        b.appendChild(obscurate);
        wrapper=document.createElement("div");
        with(wrapper.style){
            position="fixed";
            top="20px";
            left="20px";
            width="calc(100% - 40px)";
            height="calc(100% - 40px)";
            background="#fff";
            zIndex="10000000";
            overflow="auto";
            borderRadius="5px";

        }

        wrapper.appendChild(build_header());
        wrapper.appendChild(container);
        b.appendChild(wrapper);
        $("html").css("overflow","hidden");


        $(obscurate).on("click",function(e){
            insert_data();
        })
        sendData=[];

        $.ajax({
            url: window.echidna_url+"media/ajax-list?b=ajax",
            // context: $(target),
            data:sendData,
            invokedata:{
                prova:"we",

            },
            // context:$(context),

            method:"POST",
            success: function (d) {
                $(container).html(d);
                ajaxify(container,container);

                $(window).on("popup_return_data",function(e,ret){
                    console.log(ret)
                    // insert_data(ret);
                })

                $(window).on("popup_close",function(e){
                    b.removeChild(obscurate);
                    b.removeChild(wrapper);
                    $(window).off("popup_return_data");
                    $(window).off("popup_close");
                    $("html").css("overflow","auto");
                })

            }
        });


        function insert_data(ret){

            (function (r,e,b,o,w){


                $.ajax({
                    url: window.echidna_url+"media/ajax_get_single/"+r+"?b=ajax",
                    // context: $(target),
                    data:sendData,
                    invokedata:{
                        prova:"we",
                    },
                    // context:$(context),

                    method:"POST",
                    success: function (d) {


                        console.log(d);
                        item=JSON.parse(d);
                        ret=item.permalink;

                        e.selection.setContent('<img src="'+window.media_url+ret+'">');

                    }
                })

            })(ret,e,b,obscurate,wrapper);

        }



    }
});