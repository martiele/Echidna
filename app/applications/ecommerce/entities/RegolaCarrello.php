<?php

namespace applications\ecommerce\entities;

use core\db\Field;
use core\Model;

class RegolaCarrello extends Model{
    static function schema()
    {
        return array_merge([
            "id"            =>  Field::primaryIndex(),
            "nome"          =>  Field::varchar(256)->editable(),
            "categoria"     =>  Field::int()->editable()->setTemplate("select")->setTemplateVar(Categoria::getForSelect("nome","id")),
            "azione"        =>  Field::varchar(128)->editable()->setTemplate("select")->setTemplateVar([
                ["label"    =>  "-- Nessuna azione --", "value" =>  "" ],
                ["label"    =>  "Aggiungi prodotto al carrello", "value" =>  "aggiungi" ],
                ["label"    =>  "Rimuovi prodotto dal carrello", "value" =>  "rimuovi" ],
            ]),
            "sku_prodotto"   =>  Field::varchar(128)->editable()->index()->hideIf("azione",[""]),
            "_order"    =>  Field::orderField()

        ],parent::schema()); // TODO: Change the autogenerated stub
    }


    /**
     * @param $carrello Carrello
     */
    public function apply( $carrello ){


        $active = false;

        $idVariants=[];

        if( !empty($this->categoria) ){
            foreach ($carrello->lineitems as $key=>$lineitem){
                $idProdotto = $lineitem->prodotto->id;
                $idVariants[] = $lineitem->id_variant;
                if( $c = Categoria::query(true)
                    ->setFields(Categoria::getTable().".id,".Categoria::getTable().".padre")
                    ->join(CategoriaProdotto::getEntity(),"id_categoria","id")
                    ->where(CategoriaProdotto::getTable().".id_prodotto=".$idProdotto)->getAll() ){
                    foreach ($c as $k=>$categoria){
                        if( $this->categoria == $categoria->id || $this->categoria == $categoria->padre){
                            $active = true;
                        }
                    }
                }


            }
        }



            switch ($this->azione){
                case "aggiungi" :
                    if($active){
                        $prodotto = Prodotto::query()
                            ->where('sku="'.$this->sku_prodotto.'"')->getOne();
                        if($prodotto) {
                            if( !in_array($prodotto->variantePrimaria->id,$idVariants) ){



                                $l = new LineItem($prodotto->variantePrimaria->id,1);
                                $carrello->add($l,false);
                            }
                        }
                    }else{
                        $prodotto = Prodotto::query()
                            ->where('sku="'.$this->sku_prodotto.'"')->getOne();



                        if($prodotto && !empty($prodotto->variantePrimaria)) {
                            $carrello->removeByVariant($prodotto->variantePrimaria->id);

                        }
                    }
                    break;


                case "rimuovi":

                    if($active)
                    $carrello->removeByVariantSku($this->sku_prodotto);
                    break;
            }


    }
}